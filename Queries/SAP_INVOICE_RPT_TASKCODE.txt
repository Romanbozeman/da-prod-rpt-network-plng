WITH 
  PRPS AS (SELECT * FROM `da-prod-rpt-finance.SLT_S4.prps` WHERE operation_flag = 'L' AND POST1 <> 'DO-NOT-USE - Smoke Testing'), 
  ACDOCA AS (
    SELECT *, RANK() OVER (PARTITION BY RCLNT, RLDNR, RYEAR, RBUKRS, BELNR, DOCLN, gjahr ORDER BY RECORDSTAMP DESC) AS Latest_Record,
    CONCAT(RBUKRS, BELNR, GJAHR) AS VIN_UNIQUE,
    CONCAT(SUBSTRING(PS_POSID, 0, 1), '-', SUBSTRING(PS_POSID, 2, 6)) AS WBS,
    FROM `da-prod-rpt-finance.SLT_S4.acdoca`
    WHERE operation_flag <> 'D' AND rldnr ='0L' AND (
      (gkont = '0015080000') or (ps_posid IS NOT NULL AND PS_POSID LIKE 'B%' AND RACCT <> '0051039000')
    )
  ),
  SKAT AS (SELECT * FROM `da-prod-rpt-finance.SLT_S4.skat` WHERE operation_flag = 'L' ), 
  ZTFI AS (SELECT * FROM `da-prod-rpt-finance.SLT_S4.ztfi_reg_account` WHERE operation_flag = 'L'),
  MAKT AS (SELECT *,RANK() OVER (PARTITION BY matnr ORDER BY recordstamp DESC) AS MAKT_Latest_Record FROM `da-prod-rpt-finance.SLT_S4.makt`),
  BKPF AS (SELECT *, RANK() OVER (PARTITION BY RLDNR, BUKRS, BELNR, GJAHR ORDER BY RECORDSTAMP DESC) AS BKPF_Latest_Record,
  CONCAT(BUKRS, BELNR, GJAHR) AS VIN_UNIQUE, FROM `da-prod-rpt-finance.SLT_S4.bkpf`),
  TICKET_OVERVIEW AS (SELECT * FROM `da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.TICKET_OVERVIEW_V`),
  CUPS_ITEMS AS (SELECT  *, SPLIT(PROPERTIES_WBS, '.')[OFFSET(0)] AS IQGEO_CUPS_PROJECT_NUMBER,
  PROPERTIES_QTY_COMPLETED*PROPERTIES_UNIT_PRICE AS IQGEO_TOTAL_COST FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_CUPS_ITEMS_V WHERE PROPERTIES_DELETED IS NOT true),
  LINE_ITEMS AS (SELECT *  FROM  da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_CUPS_V CUPS
  LEFT JOIN CUPS_ITEMS ON CAST(CUPS_ITEMS.PROPERTIES_MYWCM_CUPS AS INT64) = CUPS.PROPERTIES_ID AND CUPS.PROPERTIES_DELETED IS NOT true),
  WBS_ELEMENT AS (SELECT  * FROM  da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_WBS_ELEMENTS_V),
  FPS_SCENARIO AS (SELECT * FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.FPS_SCENARIO_V WHERE PROPERTIES_STATUS <> 'fps.designState.Cancelled'),
  BRSPD_PREMS AS (SELECT WC_CLLI, SUM(INITIAL_DESIGN_ADDR_CT) AS ADDR_CT, SUM(INITIAL_DESIGN_PREM_CT) AS PREM_CT FROM da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.BRSPD_PREMS_V GROUP BY 1)
SELECT 
  ACDOCA.RBUKRS AS COMPANY_CODE,
  ACDOCA.BELNR AS DOCUMENT_NO, 
  ACDOCA.DOCLN AS DOCUMENT_LINE_NO,
  CONCAT(ACDOCA.RBUKRS, ACDOCA.BELNR, ACDOCA.DOCLN, ACDOCA.GJAHR) AS DOCUMENT_UNIQUE,
  ACDOCA.GJAHR AS FISCAL_YEAR,
  ACDOCA.ZZTX01 AS STATE,
  ACDOCA.BLDAT AS DOCUMENT_DATE,
  ACDOCA.BLART AS DOCUMENT_TYPE,
  ACDOCA.BUDAT AS POSTING_DATE,
  PRPS.POSKI AS OBJECT,
  CONCAT(SUBSTRING(ACDOCA.PS_POSID, 0, 1), '-', SUBSTRING(ACDOCA.PS_POSID, 2, 6), '.', SUBSTRING(ACDOCA.PS_POSID, 8, 1), '.', SUBSTRING(ACDOCA.PS_POSID, 9, 2)) AS ACDOCA_OBJECT,
  PRPS.POST1 AS OBJECT_DESCRIPTION,
  ACDOCA.WBS,
  MAKT.MATNR AS MATERIAL_LINE_ITEM_CODE,
  ACDOCA.EBELN AS PURCHASE_ORDER,
  MAKT.MAKTX AS MATERIAL_LINE_ITEM_DESCRIPTION,
  BKPF.XBLNR AS VENDOR_INVOICE_NUMBER,
  ACDOCA.RACCT AS COST_ELEMENT,
  SKAT.TXT50 AS COST_ELEMENT_NAME, 
  ACDOCA.GKONT AS OFFSETTING_ACCOUNT,
  ACDOCA.ZZREGAC AS REG_ACCOUNT,
  ZTFI.ZDESC AS REG_ACCOUNT_DESCRIPTION,
  ACDOCA.TSL AS VAL_CO_AREA_CRCY,
  ACDOCA.OPERATION_FLAG AS OPERATION_FLAG,
  PRPS.USR00 AS SAP_TICKET_ID,
  TICKET_PROPERTIES_ID,
  TICKET_STATUS,
  TICKET_TYPE,
  TICKET_TYPE_CATEGORY,
  TICKET_CREATED_DATETIME,
  TICKET_START_DATETIME,
  TICKET_DUE_DATETIME,
  TICKET_CREATOR_USERNAME,
  TICKET_ASSIGNED_USERNAME,
  TICKET_ASSIGNED_DATETIME,
  TICKET_REGION,
  PARENT_TICKET_PROJECT_NAME,
  PARSED_CLLI,
  WC_TICKET_CLLI,
  WC_SAP_PROJECT_NUMBER,
  WC_PROFILE,
  WC_COMPANY_CODE,
  WC_INVESTMENT_YEAR,
  WC_CONTRACTOR,
  WC_REQUESTOR_COST_CENTER,
  WC_RESPONDER_COST_CENTER,
  WC_CITY,
  WC_STATE,
  WC_ZIP,
  WC_LOCATION,
  WBS_ELEMENT.PROPERTIES_ID AS WBS_ID,
  WBS_ELEMENT.PROPERTIES_STATUS AS WBS_STATUS,
  WBS_ELEMENT.PROPERTIES_WBS_ELEMENT_DESCRIPTION AS WBS_ELEMENT,
  WBS_ELEMENT.PROPERTIES_STATISTICAL AS WBS_STATISTICAL,
  WBS_ELEMENT.PROPERTIES_INTEREST_PROFILE AS WBS_INTEREST_PROFILE,
  WBS_ELEMENT.PROPERTIES_INVESTMENT_PROFILE AS WBS_INVESTMENT_PROFILE,
  WBS_ELEMENT.PROPERTIES_REG_ACCOUNT AS WBS_REG_ACCOUNT,
  WBS_ELEMENT.PROPERTIES_CITY AS WBS_WC_NAME,
  LINE_ITEMS.PROPERTIES_TASK_CODE AS LINE_ITEM_TASK_CODE,
  LINE_ITEMS.PROPERTIES_DESCRIPTION AS LINE_ITEM_DESCRIPTION,
  LINE_ITEMS.PROPERTIES_VENDOR AS LINE_ITEM_VENDOR,
  -- FPS_SCENARIO.PROPERTIES_ID AS FPS_SCENARIO_ID,
  -- FPS_SCENARIO.PROPERTIES_TITLE AS FPS_SCENARIO_TITLE,
  -- FPS_SCENARIO.PROPERTIES_DESCRIPTION AS FPS_SCENARIO_DESCRIPTION,
  -- FPS_SCENARIO.PROPERTIES_STATUS AS FPS_SCENARIO_TITLE_STATUS,
  -- FPS_SCENARIO.PROPERTIES_USER_GROUP AS FPS_SCENARIO_USER_GROUP,
  -- FPS_SCENARIO.PROPERTIES_SCENARIO_TYPE AS FPS_SCENARIO_SCENARIO_TYPE,
  -- FPS_SCENARIO.PROPERTIES_SESSION_ID AS FPS_SCENARIO_SESSION_ID,
  -- FPS_SCENARIO.PROPERTIES_COMPUTATION_TYPE AS FPS_SCENARIO_COMPUTATION_TYPE,
  -- FPS_SCENARIO.PROPERTIES_COMPUTATION_STATE AS FPS_SCENARIO_COMPUTATION_STATE,
  -- FPS_SCENARIO.PROPERTIES_COMPUTATION_LOG AS FPS_SCENARIO_COMPUTATION_LOG,
  -- FPS_SCENARIO.PROPERTIES_COMPUTATION_LANG AS FPS_SCENARIO_COMPUTATION_LANG,
  -- FPS_SCENARIO.PROPERTIES_APPLICATION_SERVER AS FPS_SCENARIO_APPLICATION_SERVER,
  -- FPS_SCENARIO.PROPERTIES_MASTER_SCENARIO_ID AS FPS_SCENARIO_MASTER_SCENARIO_ID,
  -- FPS_SCENARIO.PROPERTIES_ASSIGNED_VENDOR AS FPS_SCENARIO_ASSIGNED_VENDOR,
  -- FPS_SCENARIO.PROPERTIES_FORCE_DERIVATION_RESET AS FPS_SCENARIO_FORCE_DERIVATION_RESET,
  -- FPS_SCENARIO.PROPERTIES_DERIVATION_RESULTS AS FPS_SCENARIO_DERIVATION,
  -- FPS_SCENARIO.PROPERTIES_CM_PROJECT_TRACKING_NUMBER AS FPS_SCENARIO_CM_PROJECT_TRACKING_NUMBER,
  -- FPS_SCENARIO.PROPERTIES_OPTIMIZATION_RESULTS AS FPS_SCENARIO_OPTIMIZATION,
  BRSPD_PREMS.ADDR_CT AS ADDRESS_COUNT,
  BRSPD_PREMS.PREM_CT AS PREM_COUNT
FROM ACDOCA
LEFT JOIN PRPS ON ACDOCA.PS_POSID = PRPS.POSID 
INNER JOIN SKAT ON ACDOCA.RACCT = SKAT.saknr
LEFT JOIN ZTFI ON ACDOCA.ZZREGAC = SUBSTRING(ZTFI.ZZREGAC, 2, 6) 
LEFT JOIN MAKT ON ACDOCA.MATNR = MAKT.MATNR and MAKT_Latest_Record = 1
LEFT JOIN BKPF ON ACDOCA.VIN_UNIQUE = BKPF.VIN_UNIQUE and BKPF_Latest_Record = 1
LEFT JOIN TICKET_OVERVIEW ON PRPS.USR00 = TICKET_OVERVIEW.TICKET_PROPERTIES_ID
LEFT JOIN LINE_ITEMS ON BKPF.XBLNR = LINE_ITEMS.PROPERTIES_REFERENCE AND LINE_ITEMS.IQGEO_CUPS_PROJECT_NUMBER = ACDOCA.WBS AND LINE_ITEMS.IQGEO_TOTAL_COST = ACDOCA.TSL
-- LEFT JOIN FPS_SCENARIO ON TICKET_OVERVIEW.TICKET_PROPERTIES_ID = FPS_SCENARIO.PROPERTIES_CM_PROJECT_TRACKING_NUMBER
-- LEFT JOIN FPS_SCENARIO ON TICKET_OVERVIEW.PARSED_CLLI = LEFT(FPS_SCENARIO.PROPERTIES_TITLE,8)
-- LEFT JOIN BRSPD_PREMS ON BRSPD_PREMS.SCENARIO_ID = CAST(FPS_SCENARIO.PROPERTIES_ID AS INT64)
LEFT JOIN BRSPD_PREMS ON BRSPD_PREMS.WC_CLLI = TICKET_OVERVIEW.PARSED_CLLI
LEFT JOIN WBS_ELEMENT ON WBS_ELEMENT.PROPERTIES_LEVEL_2_WBS = PRPS.POSKI AND WBS_ELEMENT.PROPERTIES_PROJECT_NUMBER_IQGEO = PRPS.USR00 
WHERE ACDOCA.Latest_Record = 1