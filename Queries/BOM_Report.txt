WITH
  FPS_BOM_REPORT AS (
  SELECT
    FPS_SCENARIO.PROPERTIES_ID AS FPS_SCENARIO_ID,
    FPS_SCENARIO.PROPERTIES_TITLE AS FPS_TITLE,
    FPS_SCENARIO.PROPERTIES_STATUS AS DESIGN_STATUS,
    FPS_SCENARIO.PROPERTIES_DERIVATION_RESULTS AS DERIVATION,
    FPS_SCENARIO.PROPERTIES_OPTIMIZATION_RESULTS AS OPTIMIZATION,
    FPS_SCENARIO.PROPERTIES_CM_PROJECT_TRACKING_NUMBER AS FPS_PARENT_PROPERTIES,
  FROM
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.FPS_SCENARIO_V AS FPS_SCENARIO ),
  FPS_MATERIAL_COST AS (
  SELECT
    TICKET.PROPERTIES_ID AS TICKETS_ID,
    WC_TICKET.PROPERTIES_ID AS WC_ID,
    SUM(CAST(MATERIAL_ITEMS.PROPERTIES_QTY_COMPLETED AS NUMERIC) * CAST(MATERIAL_ITEMS.PROPERTIES_UNIT_PRICE AS NUMERIC)) AS MATERIAL_COST
  FROM
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWWFM_TICKET_V AS TICKET
  INNER JOIN
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_WIRE_CENTER_PROJECT_V WC_TICKET
  ON
    WC_TICKET.PROPERTIES_MYWWFM_TICKET_ID = TICKET.PROPERTIES_ID
  INNER JOIN
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_MATERIAL_V AS MATERIAL
  ON
    MATERIAL.PROPERTIES_MYWWFM_TICKET_ID = WC_TICKET.PROPERTIES_MYWWFM_TICKET_ID
  LEFT JOIN
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_MATERIAL_ITEMS_V AS MATERIAL_ITEMS
  ON
    CAST(MATERIAL_ITEMS.PROPERTIES_MYWCM_MATERIAL AS INT64) = MATERIAL.PROPERTIES_ID
  GROUP BY
    TICKET.PROPERTIES_ID,
    WC_TICKET.PROPERTIES_ID ),
  BOM_OLT_COUNT AS (
  SELECT
    FPS_SCENARIO.PROPERTIES_ID AS FPS_SCENARIO_ID,
    COUNT(OLT.PROPERTIES_ID) AS OLT_COUNT
  FROM
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.FPS_SCENARIO_V AS FPS_SCENARIO
  LEFT JOIN
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.FIBER_OLT_V AS OLT
  ON
    CAST(FPS_SCENARIO.PROPERTIES_ID AS INT64) = CAST(SPLIT(OLT.MYW_DELTA, '/')[
    OFFSET
      (1)] AS INT64)
  GROUP BY
    FPS_SCENARIO_ID ),
  BOM_DTAP_COUNT AS (
  SELECT
    FPS_SCENARIO.PROPERTIES_ID AS FPS_SCENARIO_ID,
    COUNT(DTAP.PROPERTIES_ID) AS DTAP_COUNT
  FROM
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.FPS_SCENARIO_V AS FPS_SCENARIO
  LEFT JOIN
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.DTAP_V AS DTAP
  ON
    CAST(FPS_SCENARIO.PROPERTIES_ID AS INT64) = CAST(SPLIT(DTAP.MYW_DELTA, '/')[
    OFFSET
      (1)] AS INT64)
  GROUP BY
    FPS_SCENARIO_ID ),
  BOM_POLE_COUNT AS (
  SELECT
    FPS_SCENARIO.PROPERTIES_ID AS FPS_SCENARIO_ID,
    COUNT(POLE.PROPERTIES_ID) AS EXISTING_POLE
  FROM
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.FPS_SCENARIO_V AS FPS_SCENARIO
  LEFT JOIN
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.POLE_V AS POLE
  ON
    CAST(FPS_SCENARIO.PROPERTIES_ID AS INT64) = CAST(SPLIT(POLE.MYW_DELTA, '/')[
    OFFSET
      (1)] AS INT64)
  GROUP BY
    FPS_SCENARIO_ID ),
  BOM_HANDHOLE_COUNT AS (
  SELECT
    CAST(SPLIT(HANDHOLE_V.MYW_DELTA, '/')[
    OFFSET
      (1)] AS INT64) AS HANDHOLE_ID,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Existing Handhole') AS EXISTING_HANDHOLE,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Large - 30D-X-36W-X-48L') AS LARGE_30D_X_36W_X_48L,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Medium - 24D-X-24W-X-36L') AS MEDIUM_24D_X_24W_X_36L,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Small - 18D-X-17W-X-30L') AS SMALL_18D_X_17W_X_30L
  FROM
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.HANDHOLE_V
  GROUP BY
    HANDHOLE_ID),
  CABLE_COUNT AS (
  SELECT
    CAST(SPLIT(FIBER_CABLE_V.MYW_DELTA, '/')[
    OFFSET
      (1)] AS INT64) AS FIBER_CABLE_ID,
    COUNTIF(PROPERTIES_SPECIFICATION = '288F') AS CABLE_288F,
    COUNTIF(PROPERTIES_SPECIFICATION = '72F') AS CABLE_72F,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Jumper 2000') AS JUMPER_CABLE_2000,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Jumper 1500') AS JUMPER_CABLE_1500,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Jumper 1000') AS JUMPER_CABLE_1000,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Jumper 800') AS JUMPER_CABLE_800,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Jumper 500') AS JUMPER_CABLE_500,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Jumper 300') AS JUMPER_CABLE_300,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Jumper 150') AS JUMPER_CABLE_150,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Jumper 75') AS JUMPER_CABLE_75,
    COUNTIF(PROPERTIES_SPECIFICATION = 'Jumper 10') AS JUMPER_CABLE_10
  FROM
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.FIBER_CABLE_V AS FIBER_CABLE_V
  GROUP BY
    FIBER_CABLE_ID)
SELECT
  FPS_BOM_REPORT.*,
  FPS_MATERIAL_COST.TICKETS_ID,
  FPS_MATERIAL_COST.WC_ID,
  FPS_MATERIAL_COST.MATERIAL_COST,
  BOM_POLE_COUNT.EXISTING_POLE,
  BOM_HANDHOLE_COUNT.*,
  BOM_OLT_COUNT.OLT_COUNT,
  BOM_DTAP_COUNT.DTAP_COUNT,
  CABLE_COUNT.*
FROM
  FPS_BOM_REPORT
LEFT JOIN
  BOM_OLT_COUNT
ON
  FPS_BOM_REPORT.FPS_SCENARIO_ID = BOM_OLT_COUNT.FPS_SCENARIO_ID
LEFT JOIN
  BOM_DTAP_COUNT
ON
  FPS_BOM_REPORT.FPS_SCENARIO_ID = BOM_DTAP_COUNT.FPS_SCENARIO_ID
LEFT JOIN
  BOM_POLE_COUNT
ON
  FPS_BOM_REPORT.FPS_SCENARIO_ID = BOM_POLE_COUNT.FPS_SCENARIO_ID
LEFT JOIN
  FPS_MATERIAL_COST
ON
  FPS_MATERIAL_COST.TICKETS_ID = FPS_BOM_REPORT.FPS_PARENT_PROPERTIES
LEFT JOIN
  BOM_HANDHOLE_COUNT
ON
  BOM_HANDHOLE_COUNT.HANDHOLE_ID = CAST(FPS_BOM_REPORT.FPS_SCENARIO_ID AS INT64)
LEFT JOIN
  CABLE_COUNT
ON
  CABLE_COUNT.FIBER_CABLE_ID = CAST(FPS_BOM_REPORT.FPS_SCENARIO_ID AS INT64)