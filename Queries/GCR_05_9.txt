WITH SERVIMP AS 
( SELECT COUNT(SERVICE_IMPACT_EID) AS TOTAL_CIRCUITS, STATUS,STRING_AGG(SID, ', ') AS SID, PRODUCT, SERVIMP2BUSIMP FROM `da-prod-dwh-dw01.AV_CRPL_GCR.SERVICE_IMPACT_AV` 
GROUP BY STATUS, PRODUCT, SERVIMP2BUSIMP),
NOTES AS 
(Select 
substr(INTERNAL_1, 14,40) AS INTERNAL_1,
 CASE_NOTES2CASE,

ROW_NUMBER() OVER (PARTITION BY CASE_NOTES2CASE ORDER BY  CREATION_TIME desc) as RowNum

 FROM `da-prod-dwh-dw01.AV_CLARIFY_SA.TABLE_NOTES_LOG_AV` 
 WHERE INTERNAL_1 LIKE '%911 TEAM REVIEWING:%')


SELECT 
SERVIMP.TOTAL_CIRCUITS,
SERVIMP.SID,
SERVIMP.PRODUCT,
SERVIMP.SERVIMP2BUSIMP,
SERVIMP.STATUS,
ELM.TITLE, 
C.OBJID, 
C.ID_NUMBER, 
C.X_BUS_GRP,
C.X_REGION,
C.CUSTOMER_CODE,
C.X_CASE_TYPE_LEVEL1 AS TYPELEVEL1,
C.X_CASE_TYPE_LEVEL2 AS TYPELEVEL2,
C.X_CASE_TYPE_LEVEL3 AS TYPELEVEL3,
C.X_CASE_TYPE_LEVEL4 AS TYPELEVEL4,
C.X_CASE_TYPE_LEVEL5 AS TYPELEVEL5,
GCR.GCR_EID,
GCR.START_DATE AS STARTDATE,
DATE_DIFF(DATE(GCR.END_DATE),CURRENT_DATE(),  DAY) AS DAYS_OUT,
FORMAT_DATE('%Y-%m-%d', GCR.START_DATE) AS STARTDAY,
CURRENT_DATE AS CURRDAY,
GCR.END_DATE AS ENDDATE,
GCR.GCR2TABLE_CASE,
GCR.REQUESTOR_GROUP,
GCR.GCR2REGION,
GCR.MULTI_NIGHT,
EMP1.S_LAST_NAME||', '||EMP1.S_FIRST_NAME AS REQUESTOR_NAME,
GCR.REQUESTOR_PHONE,
BO.BUSORGIMPACT2GCR,
BO.BUSORG_ID,
BO.BUSORG_NAME AS CUSTOMERNAME,
BO.BOIMPACT_EID,
RTRIM(NOTES.INTERNAL_1,'911 TEAM REVIEWING:') AS REVIEWER,
NOTES.RowNum


FROM `da-prod-dwh-dw01.AV_CRPL_GCR.TABLE_CASE_AV` C


JOIN `da-prod-dwh-dw01.AV_CRPL_GCR.TABLE_GBST_ELM_AV`  ELM
ON C.CASESTS2GBST_ELM=ELM.OBJID
JOIN `da-prod-dwh-dw01.AV_CRPL_GCR.GCR_AV` GCR
ON GCR.GCR2TABLE_CASE=C.OBJID
LEFT  JOIN  `da-prod-dwh-dw01.AV_CODS.EMPLOYEE_AV`  EMP
ON UPPER(GCR.NOTIFICATIONS_REVIEWED_BY)=EMP.EMP_USER_NAME

JOIN `da-prod-dwh-dw01.AV_CRPL_GCR.BUSORG_IMPACT_AV`  BO ON
BO.BUSORGIMPACT2GCR=GCR.GCR_EID

LEFT JOIN  `da-prod-dwh-dw01.AV_CRPL_GCR.TABLE_EMPLOYEE_AV` EMP1
ON UPPER(GCR.REQUESTOR_LOGIN)=EMP1.X_NT_LOGIN_ID 

RIGHT OUTER JOIN SERVIMP SERVIMP ON 
BO.BOIMPACT_EID=SERVIMP.SERVIMP2BUSIMP
LEFT JOIN NOTES NOTES ON 
NOTES.CASE_NOTES2CASE=C.OBJID
AND NOTES.RowNum=1


where BO.BUSORG_ID='3-DPYSBG58Y2' AND ELM.TITLE!='Complete'  