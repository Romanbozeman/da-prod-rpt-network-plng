WITH 
  PRPS AS (SELECT * FROM `da-prod-rpt-finance.SLT_S4.prps` WHERE operation_flag = 'L' ), 
  ACDOCA AS (SELECT *, RANK() OVER (PARTITION BY RCLNT, RLDNR, RYEAR, RBUKRS, BELNR, DOCLN, gjahr ORDER BY RECORDSTAMP DESC) AS Latest_Record
    FROM `da-prod-rpt-finance.SLT_S4.acdoca`
    WHERE operation_flag <> 'D' AND rldnr ='0L' AND ps_posid IS NOT NULL AND PS_POSID LIKE 'B%' AND RACCT <> '0051039000'),
  SKAT AS (SELECT * FROM `da-prod-rpt-finance.SLT_S4.skat` WHERE operation_flag = 'L' ), 
  ZTFI AS (SELECT * FROM `da-prod-rpt-finance.SLT_S4.ztfi_reg_account` WHERE operation_flag = 'L'),
  TICKET_OVERVIEW AS (SELECT * FROM da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.TICKET_OVERVIEW_V),
  CUPS AS (SELECT *  FROM  da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_CUPS_V WHERE PROPERTIES_DELETED IS NOT true),
  CUPS_ITEMS AS (SELECT  *, SPLIT(PROPERTIES_WBS, '.')[OFFSET(0)] AS IQGEO_CUPS_PROJECT_NUMBER FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_CUPS_ITEMS_V WHERE PROPERTIES_DELETED IS NOT true),
  WBS_ELEMENT AS (SELECT  * FROM  da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_WBS_ELEMENTS_V),
  ADDRESS_COUNT AS (SELECT WIRECENTER_ID, WCNAME, COUNT(*) AS ADDRESS_COUNT, FROM da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.ADDRESS_MASTER_20230426 GROUP BY 1, 2 ORDER BY 1),
  PREM_COUNT AS (SELECT WIRECENTER_ID, SUM(CASE WHEN MDU='Y' THEN CAST(MDU_CNT AS INT64) ELSE 1 END ) AS PREM_COUNT 
    FROM da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.ADDRESS_MASTER_20230426 GROUP BY 1 ORDER BY 1)
SELECT 
  ACDOCA.RBUKRS AS Company_Code,
  ACDOCA.BELNR AS Document_No,
  ACDOCA.DOCLN AS Document_Line_No,
  CONCAT(ACDOCA.BELNR, ACDOCA.DOCLN) AS Document_Unique,
  ACDOCA.gjahr AS Fiscal_Year,
  ACDOCA.ZZTX01 AS State,
  ACDOCA.BLDAT AS Document_Date,
  ACDOCA.BLART AS Document_Type,
  ACDOCA.BUDAT AS Posting_Date,
  PRPS.POSKI AS Object,
  CONCAT(SUBSTRING(ACDOCA.PS_POSID, 0, 1), '-', SUBSTRING(ACDOCA.PS_POSID, 2, 6), '.', SUBSTRING(ACDOCA.PS_POSID, 8, 1), '.', SUBSTRING(ACDOCA.PS_POSID, 9, 2)) AS ACDOCA_Object,
  PRPS.POST1 AS Object_Description,
  CONCAT(SUBSTRING(ACDOCA.PS_POSID, 0, 1), '-', SUBSTRING(ACDOCA.PS_POSID, 2, 6)) AS WBS,
  TICKET_OVERVIEW.PARSED_CLLI AS WC_CLLI,
  ACDOCA.RACCT AS Cost_Element,
  SKAT.TXT50 AS Cost_Element_Name, 
  ACDOCA.ZZREGAC AS Reg_Account,
  ZTFI.ZDESC AS Reg_Accounts_Description,
  ACDOCA.TSL AS Val_CO_Area_Crcy,
  ACDOCA.operation_flag AS Operation_Flag,
  TICKET_PROPERTIES_ID,
  TICKET_STATUS,
  TICKET_TYPE,
  TICKET_TYPE_CATEGORY,
  TICKET_CREATED_DATETIME,
  TICKET_START_DATETIME,
  TICKET_DUE_DATETIME,
  TICKET_CREATOR_USERNAME,
  TICKET_ASSIGNED_USERNAME,
  TICKET_ASSIGNED_DATETIME,
  TICKET_REGION,
  PARENT_TICKET_PROJECT_NAME,
  PARSED_CLLI,
  WC_TICKET_CLLI,
  WC_SAP_PROJECT_NUMBER,
  WC_PROFILE,
  WC_COMPANY_CODE,
  WC_INVESTMENT_YEAR,
  WC_CONTRACTOR,
  WC_REQUESTOR_COST_CENTER,
  WC_RESPONDER_COST_CENTER,
  WC_CITY,
  WC_STATE,
  WC_ZIP,
  WC_LOCATION,
  WBS_ELEMENT.PROPERTIES_ID AS WBS_ID,
  WBS_ELEMENT.PROPERTIES_STATUS AS WBS_STATUS,
  WBS_ELEMENT.PROPERTIES_WBS_ELEMENT_DESCRIPTION AS WBS_ELEMENT,
  WBS_ELEMENT.PROPERTIES_STATISTICAL AS WBS_STATISTICAL,
  WBS_ELEMENT.PROPERTIES_INTEREST_PROFILE AS WBS_INTEREST_PROFILE,
  WBS_ELEMENT.PROPERTIES_INVESTMENT_PROFILE AS WBS_INVESTMENT_PROFILE,
  WBS_ELEMENT.PROPERTIES_REG_ACCOUNT AS WBS_REG_ACCOUNT,
  WBS_ELEMENT.PROPERTIES_CITY AS WBS_WC_NAME,
FROM ACDOCA
LEFT JOIN PRPS ON ACDOCA.PS_POSID = PRPS.POSID 
INNER JOIN SKAT ON ACDOCA.RACCT = SKAT.saknr
LEFT JOIN ZTFI ON ACDOCA.ZZREGAC = SUBSTRING(ZTFI.ZZREGAC, 2, 6) 
LEFT JOIN TICKET_OVERVIEW ON PRPS.USR00 = TICKET_OVERVIEW.TICKET_PROPERTIES_ID
LEFT JOIN 
  WBS_ELEMENT
ON 
  WBS_ELEMENT.PROPERTIES_LEVEL_2_WBS = PRPS.POSKI AND
  WBS_ELEMENT.PROPERTIES_PROJECT_NUMBER_IQGEO = PRPS.USR00 WHERE ACDOCA.Latest_Record = 1;


