WITH
  CUPS AS (
  SELECT
    *
  FROM
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_CUPS_V WHERE PROPERTIES_DELETED IS NOT true),
  CUPS_ITEMS AS (
  SELECT
    *,
    SPLIT(PROPERTIES_WBS, '.')[
  OFFSET
    (0)] AS IQGEO_CUPS_PROJECT_NUMBER
  FROM
    da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_CUPS_ITEMS_V WHERE PROPERTIES_DELETED IS NOT true),
  ADDRESS_COUNT AS (
    SELECT WIRECENTER_ID, COUNT(*) AS ADDRESS_COUNT, FROM da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.ADDRESS_MASTER_20230426 GROUP BY 1 ORDER BY 1),
    PREM_COUNT AS (SELECT WIRECENTER_ID, SUM(CASE WHEN MDU='Y' THEN CAST(MDU_CNT AS INT64) ELSE 1 END ) AS PREM_COUNT 
    FROM da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.ADDRESS_MASTER_20230426 GROUP BY 1 ORDER BY 1)
SELECT
  TICKET_PROPERTIES_ID,
  TICKET_STATUS,
  TICKET_TYPE,
  TICKET_TYPE_CATEGORY,
  TICKET_CREATED_DATETIME,
  TICKET_START_DATETIME,
  TICKET_DUE_DATETIME,
  TICKET_CREATOR_USERNAME,
  TICKET_ASSIGNED_USERNAME,
  TICKET_ASSIGNED_DATETIME,
  TICKET_REGION,
  PARENT_TICKET_PROJECT_NAME,
  PARSED_CLLI,
  WC_TICKET_CLLI,
  -- FPS_SCENARIO_ID,
  -- FPS_SCENARIO_TITLE,
  WC_SAP_PROJECT_NUMBER,
  WC_PROFILE,
  WC_COMPANY_CODE,
  WC_INVESTMENT_YEAR,
  WC_CONTRACTOR,
  WC_REQUESTOR_COST_CENTER,
  WC_RESPONDER_COST_CENTER,
  WC_CITY,
  WC_STATE,
  WC_ZIP,
  WC_LOCATION,
  CUPS.ID AS CUPS_ID,
  CUPS.PROPERTIES_PO AS CUPS_SAP_INVOICE_NO,
  CUPS_ITEMS.ID AS CUPS_ITEMS_ID,
  CUPS.PROPERTIES_REFERENCE CUPS_VENDOR_INVOICE_NO,
  CUPS.PROPERTIES_VENDOR AS IQGEO_VENDOR,
  CUPS.PROPERTIES_STATUS AS IQGEO_SAP_STATUS,
  CUPS.PROPERTIES_TICKET_TYPE AS IQGEO_TICKET_TYPE,
  CUPS.PROPERTIES_CREATED_DATE AS CUPS_CREATED_DATE,
  CUPS.PROPERTIES_SUBMITTED_DATE AS SUBMITTED_DATE, 
  CUPS.PROPERTIES_APPROVED_DATE AS CUPS_APPROVED_DATE, -- Reviewer Response Date
  CUPS_ITEMS.IQGEO_CUPS_PROJECT_NUMBER, 
  CUPS_ITEMS.PROPERTIES_STATUS AS CUPS_ITEMS_SAP_STATUS, 
  CUPS_ITEMS.PROPERTIES_QTY_COMPLETED AS IQGEO_ITEMS_QTY_COMPLETED,
  CUPS_ITEMS.PROPERTIES_UNIT_PRICE AS IQGEO_UNIT_PRICE,
  CUPS_ITEMS.PROPERTIES_QTY_COMPLETED * CUPS_ITEMS.PROPERTIES_UNIT_PRICE AS TOTAL_COST_PER_TICKET,
  CUPS_ITEMS.PROPERTIES_DESCRIPTION AS CUPS_ITEMS_DESCRIPTION,
  CUPS_ITEMS.PROPERTIES_EXTERNAL_ID AS IQGEO_EXTERNAL_ID,
  CUPS_ITEMS.PROPERTIES_EXTERNAL_MSG AS IQGEO_EXTERNAL_MSGD,
  CUPS_ITEMS.PROPERTIES_TASK_CODE AS IQGEO_TASK_CODE,
  CUPS_ITEMS.PROPERTIES_WBS AS IQGEO_CUPS_OBJECT_NUMBER, -- WBS ELEMENT
  CUPS_ITEMS.PROPERTIES_GL AS IQGEO_COST_ELEMENT,
  CASE CUPS_ITEMS.PROPERTIES_GL
    WHEN '51030200' THEN 'Contractor Labor'
    WHEN '51030100' THEN 'Minor Materials'
    WHEN '51030000' THEN 'Major Materials'
    WHEN '51030400' THEN 'Other Costs'
    WHEN '51030300' THEN 'Contractor Materials'
  ELSE
  CUPS_ITEMS.PROPERTIES_GL
END
  AS IQGEO_COST_ELEMENT_NAME,
  ADDRESS_COUNT.ADDRESS_COUNT,
  PREM_COUNT.PREM_COUNT
FROM
  `da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.TICKET_OVERVIEW_V` 
LEFT JOIN
  CUPS
ON
  CUPS.PROPERTIES_MYWWFM_TICKET_ID = TICKET_PROPERTIES_ID
LEFT JOIN
  CUPS_ITEMS
ON
  CAST(CUPS_ITEMS.PROPERTIES_MYWCM_CUPS AS INT64) = CUPS.PROPERTIES_ID
  AND IQGEO_CUPS_PROJECT_NUMBER IS NOT NULL
  LEFT JOIN
    ADDRESS_COUNT
  ON
    PARSED_CLLI = ADDRESS_COUNT.WIRECENTER_ID
  LEFT JOIN
    PREM_COUNT
  ON
    PARSED_CLLI = PREM_COUNT.WIRECENTER_ID 