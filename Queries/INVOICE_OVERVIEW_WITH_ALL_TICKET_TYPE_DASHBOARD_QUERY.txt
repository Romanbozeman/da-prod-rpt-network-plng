WITH
FPS_SCENARIO AS (
SELECT * FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.FPS_SCENARIO_V),

  TICKET AS (

  SELECT * FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWWFM_TICKET_V),

  WC_TICKET AS (

  SELECT * FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_WIRE_CENTER_PROJECT_V),
SURVEY AS (
    SELECT * FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_SURVEY_TICKET_V),
  DTAP AS (
    SELECT * FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_DTAP_TICKET_V),
  FEEDER AS (
    SELECT * FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_FEEDER_TICKET_V),
  PERMIT AS (
    SELECT * FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.PERMIT_TICKET_V),
  CUPS AS (

  SELECT * FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_CUPS_V),

  CUPS_ITEMS AS (

  SELECT *, SPLIT(PROPERTIES_WBS, '.')[OFFSET(0)] AS IQGEO_CUPS_PROJECT_NUMBER FROM da-prod-dwh-dw01.DP_BASE_IQGEO_V.MYWCM_CUPS_ITEMS_V),

  ADDRESS_COUNT AS (

    SELECT WIRECENTER_ID, COUNT(*) AS ADDRESS_COUNT, FROM da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.ADDRESS_MASTER_20230426

    GROUP BY 1

    ORDER BY 1),

  PREM_COUNT AS (
    SELECT WIRECENTER_ID, sum(CASE when MDU='Y' THEN CAST(MDU_CNT AS INT64) ELSE 1 END) AS PREM_COUNT FROM da-prod-rpt-network-plng.RPT_NETWORK_PLNG_SNDBX_DS.ADDRESS_MASTER_20230426
    GROUP BY 1
    ORDER BY 1)

SELECT

    FPS_SCENARIO.PROPERTIES_ID AS FPS_SCENARIO_ID,
    FPS_SCENARIO.PROPERTIES_TITLE AS FPS_TITLE,
    FPS_SCENARIO.PROPERTIES_DERIVATION_RESULTS AS DERIVATION,
    FPS_SCENARIO.PROPERTIES_OPTIMIZATION_RESULTS AS OPTIMIZATION,
    ADDRESS_COUNT.ADDRESS_COUNT,
    PREM_COUNT.PREM_COUNT AS MDU_COUNT,
    FPS_SCENARIO.PROPERTIES_CM_PROJECT_TRACKING_NUMBER AS FPS_PARENT_PROPERTIES,
    TICKET.PROPERTIES_ID AS TICKET_ID,
    WC_TICKET.PROPERTIES_MYWWFM_TICKET_ID AS WC_TICKET,
    TICKET.PROPERTIES_MYWWFM_STATUS,--ticket status
    TICKET.PROPERTIES_MYWWFM_PROJECT_NAME,---wire centre name from ticket table
    TICKET.PROPERTIES_MYWWFM_TYPE AS TICKET_TYPE,
    CUPS.PROPERTIES_ID AS CUPS_PROPERTIES_ID,--Invoice ID
    CUPS.PROPERTIES_TICKET_TYPE,
    CUPS.PROPERTIES_STATUS AS IQGEO_STATUS,
    CUPS_ITEMS.IQGEO_CUPS_PROJECT_NUMBER,
    CUPS_ITEMS.PROPERTIES_STATUS AS SAP_INVOICE_STATUS,
    CUPS_ITEMS.PROPERTIES_QTY_COMPLETED AS CUPS_ITEMS_QTY_COMPLETED,    
    CUPS_ITEMS.PROPERTIES_EXTERNAL_ID AS SAP_INVOICE_NUM,
    CUPS_ITEMS.PROPERTIES_UNIT_PRICE,
    /*CASE CUPS_ITEMS.PROPERTIES_GL
        WHEN '51030200' THEN 'Contractor_Labor'
        WHEN '51030100' THEN 'Minor_Materials'
        WHEN '51030000' THEN 'Major_Materials'
        WHEN '51030400' THEN 'Other_Costs'
        WHEN '51030300' THEN 'Contractor_Materials'
        ELSE CUPS_ITEMS.PROPERTIES_GL
    END AS PROPERTIES_GL_NAME*/
    CASE WHEN CUPS_ITEMS.PROPERTIES_GL = '51030200' THEN CUPS_ITEMS.PROPERTIES_UNIT_PRICE*CUPS_ITEMS.PROPERTIES_QTY_COMPLETED ELSE 0 END AS Contractor_Labor,

    CASE WHEN CUPS_ITEMS.PROPERTIES_GL = '51030100' THEN CUPS_ITEMS.PROPERTIES_UNIT_PRICE*CUPS_ITEMS.PROPERTIES_QTY_COMPLETED ELSE 0 END AS Minor_Materials,

    CASE WHEN CUPS_ITEMS.PROPERTIES_GL = '51030000' THEN CUPS_ITEMS.PROPERTIES_UNIT_PRICE*CUPS_ITEMS.PROPERTIES_QTY_COMPLETED ELSE 0 END AS Major_Materials,

    CASE WHEN CUPS_ITEMS.PROPERTIES_GL = '51030400' THEN CUPS_ITEMS.PROPERTIES_UNIT_PRICE*CUPS_ITEMS.PROPERTIES_QTY_COMPLETED ELSE 0 END AS Other_Costs,

    CASE WHEN CUPS_ITEMS.PROPERTIES_GL = '51030300' THEN CUPS_ITEMS.PROPERTIES_UNIT_PRICE*CUPS_ITEMS.PROPERTIES_QTY_COMPLETED ELSE 0 END AS Contractor_Materials
FROM

  WC_TICKET 
LEFT JOIN
  TICKET
ON
  WC_TICKET.PROPERTIES_MYWWFM_TICKET_ID = TICKET.PROPERTIES_ID
LEFT JOIN
  SURVEY
ON
  SURVEY.PROPERTIES_PARENT = TICKET.PROPERTIES_ID
LEFT JOIN
  DTAP
ON
  DTAP.PROPERTIES_PARENT = TICKET.PROPERTIES_ID
LEFT JOIN
  FEEDER
ON
  FEEDER.PROPERTIES_PARENT = TICKET.PROPERTIES_ID
LEFT JOIN
  PERMIT
ON
  PERMIT.PROPERTIES_PARENT = TICKET.PROPERTIES_ID
LEFT JOIN
  CUPS
ON
  CUPS.PROPERTIES_MYWWFM_TICKET_ID = SURVEY.PROPERTIES_MYWWFM_TICKET_ID OR
  CUPS.PROPERTIES_MYWWFM_TICKET_ID = DTAP.PROPERTIES_MYWWFM_TICKET_ID OR
  CUPS.PROPERTIES_MYWWFM_TICKET_ID = WC_TICKET.PROPERTIES_MYWWFM_TICKET_ID OR
  CUPS.PROPERTIES_MYWWFM_TICKET_ID = FEEDER.PROPERTIES_MYWWFM_TICKET_ID OR
  CUPS.PROPERTIES_MYWWFM_TICKET_ID = PERMIT.PROPERTIES_MYWWFM_TICKET_ID 
LEFT JOIN
  CUPS_ITEMS
ON
  CAST(CUPS_ITEMS.PROPERTIES_MYWCM_CUPS AS INT64) = CUPS.PROPERTIES_ID
LEFT JOIN
  FPS_SCENARIO
ON
  TICKET.PROPERTIES_ID = FPS_SCENARIO.PROPERTIES_CM_PROJECT_TRACKING_NUMBER
LEFT JOIN
  ADDRESS_COUNT
  ON 
  SPLIT(TICKET.PROPERTIES_MYWWFM_PROJECT_NAME, '-')[OFFSET(0)] = ADDRESS_COUNT.WIRECENTER_ID
LEFT JOIN
  PREM_COUNT
  ON 
  SPLIT(TICKET.PROPERTIES_MYWWFM_PROJECT_NAME, '-')[OFFSET(0)] = PREM_COUNT.WIRECENTER_ID
  --WHERE CUPS_ITEMS.IQGEO_CUPS_PROJECT_NUMBER = 'B-000006'
GROUP BY
    FPS_SCENARIO_ID,
    FPS_PARENT_PROPERTIES,
    FPS_TITLE,
    DERIVATION,
    OPTIMIZATION,
    ADDRESS_COUNT,
    MDU_COUNT,
    TICKET_ID,
    WC_TICKET,
    PROPERTIES_TICKET_TYPE,
    SAP_INVOICE_STATUS,
    PROPERTIES_MYWWFM_TYPE,
    PROPERTIES_MYWWFM_STATUS,
    PROPERTIES_MYWWFM_PROJECT_NAME,
    CUPS_PROPERTIES_ID,
    PROPERTIES_UNIT_PRICE,
    CUPS_ITEMS_QTY_COMPLETED,
    SAP_INVOICE_NUM,
    PROPERTIES_GL,
    IQGEO_STATUS,
    IQGEO_CUPS_PROJECT_NUMBER